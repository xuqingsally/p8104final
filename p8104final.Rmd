---
title: "p8104"
author: "Qing Xu"
date: "December 8, 2017"
output:
  pdf_document: default
  html_document: default
  word_document: default
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(janitor)
library(readxl)
library(data.table)
library(HH)
library(leaps)
library(car)
library(gridExtra)
library(knitr)
library(boot)
```

#Clean data
```{r}
#clean data and converting some variables
GH_data <- read_excel("GHProject_Dataset.xlsx") %>%
  clean_names() %>%
  group_by(patientid) %>%
  dplyr::mutate(is30dayreadmit = as.character(is30dayreadmit))

#count number of visit and select ICU=0
mul <- count(GH_data) 
GH_data_noICU <- left_join(GH_data,mul,by = "patientid") %>%
  filter(icu_flag == 0) %>%
  rename(num_visit = n) %>%
  data.table()

#select first visit
setkey(GH_data_noICU, patientid)
df <- GH_data_noICU[J(unique(patientid)), mult = "first"]

#select variables we interested
df <- df %>%
  dplyr::select(-c(loshours, admitdtm, icu_flag, facilityzip, postalcode, facilityname))
```


#Check the variables we interested in
```{r}
#create a list for checking the potential categorical predictors
category_check_list <- 
  df %>%
  dplyr::select(is30dayreadmit, evisit, mews, cindex, gender, race, religion, maritalstatus, insurancetype) %>%
  apply(2, table)
names(category_check_list) <- c("is30dayreadmit", "evisit", "mews", "cindex", "gender", 
                                "race", "religion", "maritalstatus", "insurancetype")
category_check_tbl <- tibble(variable = c("is30dayreadmit", "evisit", "mews", "cindex", "gender", 
                                          "race", "religion", "maritalstatus", "insurancetype"),
                             check_list = category_check_list)

#the summary data of potential continous predictors
data_summary <- 
  df %>%
    dplyr::select(-c(is30dayreadmit, evisit, mews, cindex, gender, race, 
                     religion, maritalstatus, insurancetype)) %>%
    dplyr::select(-c(patientid, visitid, losdays2, num_visit)) %>%
    gather(key = continuous_variable, value = value, ageyear:bpdiastolic) %>%
    group_by(continuous_variable) %>%
    summarise(min = min(value, na.rm = T),
              first_quantile = quantile(value,  probs = 0.25, na.rm = T),
              median = median(value, na.rm = T),
              third_quantile = quantile(value,  probs = 0.75, na.rm = T),
              max = max(value, na.rm = T))
kable(data_summary)

#we find the following four predictors should be combined
category_check_tbl$check_list[3]             #mews
category_check_tbl$check_list[4]             #cindex
category_check_tbl$check_list[6]             #race
category_check_tbl$check_list[7]             #religion
category_check_tbl$check_list[8]             #maritalstatus
```

```{r}
#combine the level we choose
df$mews<-replace(df$mews, df$mews>3, "further deterioration/immediate action required")
df$mews<-replace(df$mews, df$mews<4, "normal/increase caution")
df$cindex<-replace(df$cindex, df$cindex>4,"severe")
df$cindex<-replace(df$cindex, df$cindex==3|df$cindex==4,"moderate")
df$cindex<-replace(df$cindex, df$cindex==2|df$cindex==1,"mild")
df$cindex<-replace(df$cindex, df$cindex==0,"normal")
df$race<-replace(df$race, df$race=="Natv Hawaii/Pacf Isl","Other/Multiracial")
df$religion<-replace(df$religion, 
                     df$religion=="Angelican"|df$religion=="Hebrew"|df$religion=="Non Denominational"|df$religion=="Mormon",
                     "Other")
df$maritalstatus<-replace(df$maritalstatus, df$maritalstatus=="Civil Union","Married")
#change temperature and bmi
df[df$temperature < 24] <- NA
df[df$temperature > 47] <- NA
df[df$bmi < 7] <- NA
df[df$bmi > 50] <- NA
df[df$heartrate > 220] <- NA
df[df$o2sat > 200] <- NA
df[df$respirationrate > 50] <- NA
#omit the missing observations
df <- df %>% na.omit()
```

#transformation
```{r}
#histogram of outcome
outcome_nontran <- 
  ggplot(df,aes(x = losdays2))+
  geom_histogram(bins = 20) +
  ggtitle("histogram of length of days") + 
  theme(plot.title = element_text(hjust = 0.5))
outcome_tran <- ggplot(df,aes(x = log(losdays2)))+
  geom_histogram(bins = 15) +
  ggtitle("histogram of log(length of days)") + 
  theme(plot.title = element_text(hjust = 0.5))
grid.arrange(outcome_nontran, outcome_tran)
#use log of losdays2
df <- df %>%
  mutate(log_los=log(losdays2)) %>%
  dplyr::select(-patientid,-visitid,-losdays2,-num_visit)
#Now we have our final data for regression
```

#variables who are included
```{r}
lm_is<-lm(log_los~factor(is30dayreadmit),data=df) 
lm_mews<-lm(log_los~factor(mews),data=df) 
lm_cindex<-lm(log_los~cindex,data=df)
lm_evisit<-lm(log_los~evisit,data=df)
lm_ageyear<-lm(log_los~ageyear,data=df)
lm_gender<-lm(log_los~factor(gender),data=df) # not sig 
lm_race<-lm(log_los~factor(race),data=df) #not sig
lm_religion<-lm(log_los~factor(religion),data=df) #not sig
lm_maritalstatus<-lm(log_los~factor(maritalstatus),data=df) #not sig
lm_insurancetype<-lm(log_los~factor(insurancetype),data=df) #not sig?
lm_bmi<-lm(log_los~bmi,data=df)
lm_tem<-lm(log_los~temperature,data=df) #not sig but pvalue is 0.09, still remain
lm_hear<-lm(log_los~heartrate,data=df)
lm_res<-lm(log_los~respirationrate,data=df)
lm_bpd<-lm(log_los~bpdiastolic,data=df)
lm_bps<-lm(log_los~bpsystolic,data=df)
lm_o2<-lm(log_los~o2sat,data=df)
# remove gender,race, religion, maritalstatus,insurancetype
# religion should be discussed
lm_full<-lm(log_los~mews+is30dayreadmit+cindex+evisit+ageyear+bmi+temperature+heartrate+respirationrate+bpdiastolic+bpsystolic+o2sat,data=df)

# results from stepwise automatic
summary(step(lm_full, direction='both', trace = 0))


#select
best <- function(model, ...) 
{
  subsets <- regsubsets(formula(model), model.frame(model),nvmax=length(model$coefficients)-1, ...)
  subsets <- with(summary(subsets),
                  cbind(p = as.numeric(rownames(which)), which, rss, rsq, adjr2, cp, bic))
  
  return(subsets)
}  

# Select the 'best' 1 models of all subsets
round(best(lm_full, nbest = 1), 4) #remove mews, bmi and O2sta based on this output
```


```{r}
#fit the best model  and give a summary 
lm_best <- lm(log_los~is30dayreadmit+cindex+evisit+ageyear+temperature+heartrate+respirationrate+bpdiastolic+bpsystolic,data=df)
summary(lm_best)
#give the diagnostics plots
par(mfrow=c(2,2))
plot(lm_best, which = 1:5)
#check the the 516th, 595th and 1244th observation(patientid:477165, 558208, 1680385)
df[c(516, 595, 1244),]
rstandard(lm_best)[c(516, 595, 1244)]  #they are outliers in Y


#first from the residuals vs leverage plot, we find that they are not outliers in X
rstandard(lm_best)[c(516, 595, 1244)]  #they are outliers in Y, but their |ri|s are just a bit larger than 2.5

#since the QQplot show that there might be some outliers in Y, we can try to remove and find what happen

#find all the outliers in Y
outlier_y <- which(abs(rstandard(lm_best)) > 2.5)
#now we fit the model these points including the three influential cases
df_rm <- df[-outlier_y,]
lm_best_2 <- df_rm %>%
  lm(log_los~is30dayreadmit+cindex+evisit+ageyear+temperature+
       heartrate+respirationrate+bpdiastolic+bpsystolic,data = .)
summary(lm_best_2)
plot(lm_best_2, which = 1:5)
#we find that the QQplot become better and R^2 become larger. So we decide to remove the outliers in Y
```



## Bootstrapping 
```{r}
train <- sample(length(df), length(df)/2)

lm_best_train <- lm(log_los ~ is30dayreadmit + cindex + evisit + ageyear + temperature + heartrate + respirationrate + bpdiastolic + bpsystolic,
                    data = df, 
                    subset = train)

boot.fn <- function(data, index){
	return(coef(lm(log_los ~ is30dayreadmit + cindex + evisit + ageyear + temperature + heartrate + respirationrate + bpdiastolic + bpsystolic,
	               data = df, 
	               subset = index)))
}

# repeats sampling 10000 times
set.seed(1)
bootstrap_results <- boot(df, boot.fn, 10000)



original_coeff <- bootstrap_results$t0
bootstrap_coeff <- c(mean(bootstrap_results$t[,1]),
          mean(bootstrap_results$t[,2]),
          mean(bootstrap_results$t[,3]),
          mean(bootstrap_results$t[,4]),
          mean(bootstrap_results$t[,5]),
          mean(bootstrap_results$t[,6]),
          mean(bootstrap_results$t[,7]),
          mean(bootstrap_results$t[,8]),
          mean(bootstrap_results$t[,9]),
          mean(bootstrap_results$t[,10]),
          mean(bootstrap_results$t[,11]),
          mean(bootstrap_results$t[,12]))

bias <- c(mean(bootstrap_results$t[,1]) - bootstrap_results$t0[1],
          mean(bootstrap_results$t[,2]) - bootstrap_results$t0[2],
          mean(bootstrap_results$t[,3]) - bootstrap_results$t0[3],
          mean(bootstrap_results$t[,4]) - bootstrap_results$t0[4],
          mean(bootstrap_results$t[,5]) - bootstrap_results$t0[5],
          mean(bootstrap_results$t[,6]) - bootstrap_results$t0[6],
          mean(bootstrap_results$t[,7]) - bootstrap_results$t0[7],
          mean(bootstrap_results$t[,8]) - bootstrap_results$t0[8],
          mean(bootstrap_results$t[,9]) - bootstrap_results$t0[9],
          mean(bootstrap_results$t[,10]) - bootstrap_results$t0[10],
          mean(bootstrap_results$t[,11]) - bootstrap_results$t0[11],
          mean(bootstrap_results$t[,12]) - bootstrap_results$t0[12])

std_error <- c(sd(bootstrap_results$t[,1]),
                sd(bootstrap_results$t[,2]),
                sd(bootstrap_results$t[,3]),
                sd(bootstrap_results$t[,4]),
                sd(bootstrap_results$t[,5]),
                sd(bootstrap_results$t[,6]),
                sd(bootstrap_results$t[,7]),
                sd(bootstrap_results$t[,8]),
                sd(bootstrap_results$t[,9]),
                sd(bootstrap_results$t[,10]),
                sd(bootstrap_results$t[,11]),
                sd(bootstrap_results$t[,12]))

bootstrap_table <- cbind(original_coeff, bootstrap_coeff, bias, std_error)

colnames <- c("Original Coefficients", "Bootstrap Coefficients", "Bias", "Standard Error")
#bias and original coefficients are output
kable(bootstrap_table, 
      col.names = c("Original Coefficients", "Bootstrap Coefficients", "Bias", "Standard Error"))
```




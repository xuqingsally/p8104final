---
title: "p8104"
author: "Qing Xu"
date: "December 8, 2017"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(janitor)
library(readxl)
library(data.table)
library(HH)
library(leaps)
library(car)
```
#Clean data
```{r}
df<-read_excel("GHProject_Dataset.xlsx") %>%
  clean_names() %>%
  group_by(patientid) 

#count number of visit and select ICU=0
mul<-count(df) 
df<-left_join(df,mul,by = "patientid") %>%
   filter(icu_flag==0) %>%
   data.table()

#select first visit
setkey(df, patientid)
df<-df[J(unique(patientid)), mult = "first"]

#change temperature lower than 15 to NA
df[df$temperature < 15] <- NA
df[df$temperature > 47] <- NA
df[df$bmi < 7] <-NA
```
#transformation boxpox
```{r}
ggplot(df,aes(x = losdays2))+
  geom_histogram()

ggplot(df,aes(x = log(losdays2)))+
  geom_histogram()

#use log of losdays2
df<-df %>%
  mutate(log_los=log(losdays2)) 

```

#combine level
```{r}
df$is30dayreadmit=as.character(df$is30dayreadmit)
df$mews<-replace(df$mews, df$mews>5, "immediate action required")
df$mews<-replace(df$mews, df$mews==4|df$mews==5, "further deterioration")
df$mews<-replace(df$mews, df$mews==2|df$mews==3, "increase caution")
df$mews<-replace(df$mews, df$mews==0|df$mews==1, "normal")
df$cindex<-replace(df$cindex, df$cindex==0,"normal")
df$cindex<-replace(df$cindex, df$cindex==1|df$cindex==2,"mild")
df$cindex<-replace(df$cindex, df$cindex==3|df$cindex==4,"moderate")
df$cindex<-replace(df$cindex, df$cindex==5,"severe")


```







#variables who are included
```{r}
lm1<-lm(log_los~factor(is30dayreadmit),data=df) 
lm2<-lm(log_los~factor(mews),data=df) 
lm3<-lm(log_los~cindex,data=df)
lm4<-lm(log_los~evisit,data=df)
lm5<-lm(log_los~ageyear,data=df)
lm6<-lm(log_los~factor(gender),data=df) # not sig 
lm7<-lm(log_los~factor(race),data=df) #not sig
lm8<-lm(log_los~factor(religion),data=df) #not sig
lm9<-lm(log_los~factor(maritalstatus),data=df) #not sig
lm10<-lm(log_los~factor(insurancetype),data=df) #not sig?
lm11<-lm(log_los~bmi,data=df)
lm12<-lm(log_los~mews+temperature+heartrate+respirationrate+bpdiastolic,data=df)


df$is30dayreadmit=as.factor(df$is30dayreadmit)
mult.fit <- lm(log_los ~ mews+cindex+evisit+ageyear+bmi+is30dayreadmit, data=df)
step(mult.fit, direction='backward')

#select
best <- function(model, ...) 
{
  subsets <- regsubsets(formula(model), model.frame(model), ...)
  subsets <- with(summary(subsets),
                  cbind(p = as.numeric(rownames(which)), which, rss, rsq, adjr2, cp, bic))
  
  return(subsets)
}  

# Select the 'best' 2 models of all subsets
round(best(mult.fit, nbest = 1), 4)
```